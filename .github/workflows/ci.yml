# =============================================================================
# Guía Master IA - CI/CD Pipeline
# =============================================================================
# Ejecuta tests automáticos en cada push y PR
#
# Características:
# - Ejecuta pytest para tests unitarios
# - Ejecuta nbval para validar notebooks
# - Ejecuta ruff para linting
# - Genera badge de estado
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ===========================================================================
  # Job 1: Linting y Type Checking
  # ===========================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install linting tools
        run: |
          pip install ruff mypy

      - name: Run ruff (linting)
        run: |
          ruff check . --output-format=github

      - name: Run ruff (formatting check)
        run: |
          ruff format --check .

  # ===========================================================================
  # Job 2: Unit Tests
  # ===========================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install numpy scipy matplotlib scikit-learn pytest pytest-cov

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short --cov=. --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ===========================================================================
  # Job 3: Simulacros Tests
  # ===========================================================================
  simulacros:
    name: Test Simulacros
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install numpy scipy matplotlib scikit-learn pytest

      - name: Run simulacro tests
        run: |
          pytest tests/test_simulacro_*.py -v --tb=short

  # ===========================================================================
  # Job 4: Notebook Validation (Optional - runs on schedule)
  # ===========================================================================
  notebooks:
    name: Validate Notebooks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nbval pytest

      - name: Download NLTK data
        run: |
          python -c "import nltk; nltk.download('punkt'); nltk.download('stopwords')"

      - name: Validate M04 Labs (dry run)
        run: |
          # Solo verificar sintaxis, no ejecutar
          python -m py_compile M04_Probabilidad_Estadistica/Notebooks/Lab1_MLE_MAP.py
          python -m py_compile M04_Probabilidad_Estadistica/Notebooks/Lab2_MonteCarlo_MCMC.py
          python -m py_compile M04_Probabilidad_Estadistica/Notebooks/Lab3_MarkovChains.py
        continue-on-error: true

  # ===========================================================================
  # Job 5: Build Check
  # ===========================================================================
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [test, simulacros]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install all dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true

      - name: Verify imports
        run: |
          python -c "import numpy; import pandas; import sklearn; print('Core imports OK')"

      - name: Build success
        run: |
          echo "✅ All checks passed!"
          echo "Repository is ready for use."
